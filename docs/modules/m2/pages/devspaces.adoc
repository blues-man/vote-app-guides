# Vote App Lab Development - Dev Spaces

With the Vote Application deployed to our `vote-app-dev-%USERID%` project, we can now use OpenShift Dev Spaces to develop and test our application. link:https://developers.redhat.com/products/openshift-dev-spaces/overview[OpenShift Dev Spaces,role='params-link',window='_blank'] is a browser-based IDE that allows you to develop in the cloud. It provides a ready-to-use development stack with a web-based IDE, terminal, and version control support. It also provides pre-built developer workspaces that allow you to start coding immediately, which we'll be using in this lab. We'll make a quick change to the source code of our `vote-ui` application, see the results in real-time, and push these changes to our repository.

## Getting setup with Dev Spaces

Let's start out with getting more familiar with the Dev Spaces interface. To do this, we can begin with navigating to Dev Spaces from the OpenShift Console. To do this, click on the application launcher at the top right corner of the OpenShift Web Console and select `Red Hat OpenShift Dev Spaces`.

image::devspaces-button.png[Dev Spaces Button]

This will open up the Dev Spaces interface. You'll need to firstly authorize Dev Spaces to access your OpenShift cluster. Next, you'll see the `vote-ui` workspace from within the Dev Spaces dashboard. Click on the `vote-ui` workspace and hit *Actions* from the top right corner, then click *Start* to enter the Dev Spaces IDE.

image::devspaces-workspaces.png[Dev Spaces Workspaces]

Once the Dev Spaces interface opens, we'll have to hit *Trust Workspace & Install* as well as *Yes, I trust the authors* to install the required components and enable permissions needed for this lab.

image::devspaces-permissions.png[Dev Spaces Permissions]

There may be some _Get Started_ tabs in the dashboard that you can close, but from here, we can begin to make our changes to the Vote Application. But first, let's get familiar with the powerful features of Dev Spaces.

image::devspaces-interface.png[Dev Spaces Interface]

### Extension support

// Add a link here
Built from the open Eclipse Che project, Dev Spaces provides support for Microsoft Visual Studio Code extensions and Language Server Protocol. This means that you can use your favorite Visual Studio Code extensions in Dev Spaces. You can also use the Language Server Protocol to provide language features like auto-complete, go-to-definition, and hover support.

image::devspaces-extensions.png[Dev Spaces Extensions]

### Terminal support

Dev Spaces also provides a terminal that allows you to run commands in your workspace. This is useful for running commands like `mvn clean package` or `npm install` to build your application. You can also use the terminal to run commands within your OpenShift cluster without needing to authenticate, just like the OpenShift Web Terminal.

image::devspaces-terminal.png[Dev Spaces Terminal]

With the Dev Spaces built-in terminal, let's run the following commands to test out a bit of Python code to print some text in our terminal.

[.console-input]
[source,python,subs="+attributes,macros+"]
----
python
----

[.console-input]
[source,python,subs="+attributes,macros+"]
----
print("Hello from Summit 2023!")
----

[.console-input]
[source,python,subs="+attributes,macros+"]
----
quit()
----

image::devspaces-terminal-python.png[Dev Spaces Terminal Python]

### Git support

Dev Spaces also provides a built-in version control system. This allows you to commit and push your changes to a Git repository. You can also use the version control system to pull changes from a Git repository.

image::devspaces-git.png[Dev Spaces Git]

## Editing the Vote Application in Dev Spaces

### Installing the application dependencies

Let's first setup the dependencies for our application and run the Vote Application locally. From the top left corner, we can select *Terminal* and then *Run Task*. 

image::devspaces-run-task.png[Dev Spaces Run Task]

From here, we can select *Show all tasks* and *devfile: Install dependencies*. This will install the necessary Python dependencies for the Vote Application.

image::devspaces-run-task-2.png[Dev Spaces Run Task]

Next, we can select *Terminal* and then *Run Task* again. From here, we can select *Show all tasks* and *devfile: Run Python App*. This will run the Vote Application in development.

image::devspaces-run-app.png[Dev Spaces Run App]

You'll now see a pop-up in the lower right corner about a new process running on port 8080. Using this, we will be able to see live code changes to the Vote Application running in the browser.

image::devspaces-run-app-browser.png[Dev Spaces Run App Browser]

From here, we can click on the *Open* button to open the Vote Application in a new browser tab. It may take a few seconds, but you should see the Vote Application running.

image::devspaces-run-app-browser-1.png[Dev Spaces Run App Browser]

From the Dev Spaces interface, we can now begin to make changes to the Vote Application. To do this, we can edit the `index.html` file in the `templates` directory. 

### Live coding within Dev Spaces

image::devspaces-edit.png[Dev Spaces Edit]

Here, on line 16, we can change the text from `{{option_a}} vs {{option_b}}!` to `{{option_a}} vs {{option_b}}! - Red Hat Summit 2023`. This will change the title of the Vote Application to *Vote App - Red Hat Summit 2023*. Feel free to copy the below code and insert it on line 16.

[.console-input]
[source,python,subs="+attributes,macros+"]
----
<h1>{{option_a}} vs {{option_b}}! - Red Hat Summit 2023</h1>
----

image::devspaces-edit-title.png[Dev Spaces Edit Title]

Now, if we return to our new tab with the local Vote Application running, we can see the new changes we've made, updated automatically.

image::devspaces-run-app-browser-2.png[Dev Spaces Run App Browser]

## Performing a security scan

// TODO: Add a link here
Now that we've made our changes to the Vote Application, we can secure our application and analyze our dependencies by performing a security scan. Dependency Analytics is powered by Snyk Intel Vulnerability DB, the most advanced and accurate open source vulnerability database in the industry.

To do this, we can right click the *requirements.txt* file from the left menu. From here, we can select *Dependency Analytics Report* to perform a security scan on the Vote Application.

image::devspaces-snyk.png[Dev Spaces Snyk]

This will open up a new tab in Dev Spaces with the results of the security scan. Here, we can see information about security issues, dependencies, licenses, and add-ons.

image::devspaces-snyk-report.png[Dev Spaces Snyk Report]

## Pushing changes to the Git repository

Now that we've tested our changes, we can push our changes to the Git repository. To do this, we can select the *Source Control* tab from the left menu. From here, we can select the *âœ“ Commit* button to stage all of our changes. We can then enter a commit message (ex. `Modified index.html header`) and commit, as well as push our changes to the Git repository.

image::devspaces-commit.png[Dev Spaces Commit]

Finally, you'll be prompted to enter your credentials to push your changes to the Git repository. To recall, your credentials are:

- Username: `%USERID%`
- Password: `openshift`

## Syncing changes to the Vote Application

Now that we've pushed our changes to the Git repository, and with the webhook configured, our changes trigger a rebuild of the `vote-ui` application image. To see this in real time, we can navigate to the OpenShift Web Console and select the `vote-app-ci-%USERID%` project. From here, we can select *Pipelines* from the left menu. We should see the pipeline `vote-app-ui-pipeline` running and rebuilding the Vote Application.

image::devspaces-pipeline.png[Dev Spaces Pipeline]

Once the pipeline has completed, in the link:https://gitea.%SUBDOMAIN%/%USERID%/vote-app-gitops/[vote-app-gitops,role='params-link',window='_blank'] repository, there will be a new commit from Tekton that will contain the new hash for the Vote Application image. 

image::devspaces-gitops-commit.png[Dev Spaces GitOps Commit]

Now, Argo CD will automatically pick up on these changes from the repository. To deploy the new image to the `vote-app-dev-%USERID%` project, head back to Argo CD and select the `vote-app-dev-%USERID%` application. You'll see that the application is now out of sync, and hasn't updated, as we declared in our `Application` resource that we didn't want _self healing_ enabled. To view the new changes however, from the top menu, click on *Sync*.

image::devspaces-argocd-sync.png[Dev Spaces Argo CD Sync]

Now, select *Synchronize*. This will deploy the new image to the `vote-app-dev-%USERID%` project.

image::argocd-sync.png[Argo CD Sync]

## Next steps

Making these changes manually is a good solution for our development environment, but let's move this application to production and automate all of this. For this, we can use a separate pipeline that will deploy the application to the `vote-app-prod-%USERID%` project.